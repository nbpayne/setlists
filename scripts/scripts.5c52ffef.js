!function(){"use strict";function a(a,b,c,d){a.state("login",{url:"/login",templateUrl:"components/login/login.html",controller:"Login",controllerAs:"vm",secure:!1}).state("authorize",{url:"/authorize",templateUrl:"components/authorize/authorize.html",controller:"Authorize",controllerAs:"vm",secure:!1}).state("set-lists",{url:"/set-lists",templateUrl:"components/set-lists/set-lists.html",controller:"SetLists",controllerAs:"vm",secure:!0}).state("set-list",{url:"/set-lists/:setListID",templateUrl:"components/set-list/set-list.html",controller:"SetList",controllerAs:"vm",secure:!0}),b.otherwise("/set-lists"),c.init({appId:d,status:!0,cookies:!1,xfbml:!1,version:"v2.6"})}function b(a,b,c,d,e){a.$on("$stateChangeStart",function(a,d,f,g,h){e.location.search?e.location.search.includes("?code=")?e.location.href=e.location.origin+e.location.pathname+"#/authorize":e.location.href=e.location.origin+e.location.pathname+"#/set-lists":d.secure&&!b.user().isLoggedIn&&(c.transitionTo("login"),a.preventDefault())}),a.$on("authenticate",function(a,b){b.authenticated?c.transitionTo("set-lists"):c.transitionTo("login")})}angular.module("SetListApp",["angular-momentjs","facebook","ngDraggable","ngResource","SetListApp.config","ui.bootstrap","ui.bootstrap.datetimepicker","ui.router"]).constant("VERSION","0.14.0").config(a).run(b),a.$inject=["$stateProvider","$urlRouterProvider","$facebookProvider","FB_APPID"],b.$inject=["$rootScope","UserService","$state","$facebook","$window"]}(),function(){"use strict";angular.module("SetListApp").filter("future",function(){return function(a){var b=[];return angular.forEach(a,function(a){Date.parse(a.date)>=Date.parse(Date())&&b.push(a)}),b}})}(),function(){"use strict";angular.module("SetListApp").filter("past",function(){return function(a){var b=[];return angular.forEach(a,function(a){Date.parse(a.date)<Date.parse(Date())&&b.push(a)}),b}})}(),function(){"use strict";function a(a,b){return a(b+"/authorizations/:accessToken")}angular.module("SetListApp").factory("AuthorizationResource",a),a.$inject=["$resource","API"]}(),function(){"use strict";function a(){function a(){if("undefined"!=typeof localStorage){var a=parseInt(localStorage.mongoMachineId);a>=0&&16777215>=a&&(e=Math.floor(localStorage.mongoMachineId)),localStorage.mongoMachineId=e}}function b(){var a=Math.floor((new Date).valueOf()/1e3);c++,c>16777215&&(c=0);var b=a.toString(16),f=e.toString(16),g=d.toString(16),h=c.toString(16);return"00000000".substr(0,8-b.length)+b+"000000".substr(0,6-f.length)+f+"0000".substr(0,4-g.length)+g+"000000".substr(0,6-h.length)+h}var c=0,d=Math.floor(32767*Math.random()),e=Math.floor(16777216*Math.random()),f={getObjectId:b};return a(),f}angular.module("SetListApp").service("ObjectIdService",a)}(),function(){"use strict";function a(a,b){return a(b+"/set-lists/:setListID",{},{update:{method:"PUT"}})}angular.module("SetListApp").factory("SetListResource",a),a.$inject=["$resource","API"]}(),function(){"use strict";function a(a,b){return a(b+"/song-lists/:songListID",{},{update:{method:"PUT"}})}angular.module("SetListApp").factory("SongListResource",a),a.$inject=["$resource","API"]}(),function(){"use strict";function a(a,b,c){function d(){var a=angular.fromJson(localStorage.authorization);return a?(b.defaults.headers.common["auth-token"]=a.authToken,{isLoggedIn:!0,name:a.firstName+" "+a.lastName,band:a.band,songListID:a.songListID}):{isLoggedIn:!1,name:void 0,band:void 0,songListID:void 0}}function e(b){a.get({accessToken:b.accessToken},function(a){localStorage.authorization=angular.toJson(a),c.$broadcast("authenticate",{authenticated:!0})},function(a){console.log(a)})}function f(){var a=angular.fromJson(localStorage.authorization);a&&(localStorage.removeItem("authorization"),delete b.defaults.headers.common["auth-token"],c.$broadcast("authenticate",{authenticated:!1}))}return{user:d,login:e,logout:f}}angular.module("SetListApp").service("UserService",a),a.$inject=["AuthorizationResource","$http","$rootScope"]}(),function(){"use strict";function a(a,b,c,d){function e(){i=a(function(){if(d.setListID){var a=angular.fromJson(localStorage["songList_"+angular.fromJson(localStorage["setList_"+d.setListID]).data.songListID]);void 0!==a&&a.isDirty&&b.saveSongListToServer(a);var e=angular.fromJson(localStorage["setList_"+d.setListID]);void 0!==e&&e.isDirty&&c.saveSetListToServer(e)}},2e3)}function f(){a.cancel(i)}function g(){i=a(function(){var a=angular.fromJson(localStorage.dirtyLaundry);if(void 0!==a)for(var b=0;b<a.length;b++)c.deleteSetListFromServer(a[b])},2e3)}function h(){a.cancel(i)}var i;return{startSetListSynchroniser:e,stopSetListSynchroniser:f,startSetListsSynchroniser:g,stopSetListsSynchroniser:h}}angular.module("SetListApp").service("SynchronisationService",a),a.$inject=["$interval","SongListService","SetListService","$stateParams"]}(),function(){"use strict";function a(a){function b(b){a.query({},function(a){var d={};d.data=a,b(d),c(d,!1)},function(a){var c=angular.fromJson(localStorage.setLists);void 0===c&&(c={},c.data=[]),b(c)})}function c(a){localStorage.setLists=angular.toJson(a)}function d(b,c){a.get({setListID:b},function(a){var b={};b.data=a,c(b),e(b,!1)},function(a){var d=angular.fromJson(localStorage["setList_"+b]);void 0===d&&(d={},d.data=[]),c(d)})}function e(a,b){void 0===b&&(b=!0),a.isDirty=b,localStorage["setList_"+a.data._id]=angular.toJson(a)}function f(b){console.log("Save set list to server!"),a.update({setListID:b.data._id},b.data,function(a){e(b,!1),console.log(a)},function(a){console.log(a)})}function g(a){var b=angular.fromJson(localStorage.dirtyLaundry);void 0===b&&(b=[]),b.push(a),localStorage.dirtyLaundry=angular.toJson(b)}function h(b){console.log("Delete set list from server"),a["delete"]({setListID:b},function(a){var c=angular.fromJson(localStorage.dirtyLaundry);c.splice(c.indexOf(b),1),localStorage.dirtyLaundry=angular.toJson(c),console.log(a)},function(a){console.log(a)})}return{getSetLists:b,saveSetLists:c,getSetList:d,saveSetList:e,saveSetListToServer:f,deleteSetList:g,deleteSetListFromServer:h}}angular.module("SetListApp").service("SetListService",a),a.$inject=["SetListResource"]}(),function(){"use strict";function a(a){function b(b,d){a.get({songListID:b},function(a){var b={};b.data=a,d(b),c(b,!1)},function(a){var c=angular.fromJson(localStorage["songList_"+b]);void 0===c&&(c={},c.data=[]),d(c)})}function c(a,b){void 0===b&&(b=!0),a.isDirty=b,localStorage["songList_"+a.data._id]=angular.toJson(a)}function d(b){console.log("Save song list to server!"),a.update({songListID:b.data._id},b.data,function(a){c(b,!1),console.log(a)},function(a){console.log(a)})}return{getSongList:b,saveSongList:c,saveSongListToServer:d}}angular.module("SetListApp").service("SongListService",a),a.$inject=["SongListResource"]}(),function(){"use strict";function a(a,b,c){function d(){b.getLoginStatus().then(function(b){"connected"===b.status?a.login(b.authResponse):a.logout()},function(a){console.log(a)})}d()}angular.module("SetListApp").controller("Authorize",a),a.$inject=["UserService","$facebook","FB_APPID"]}(),function(){"use strict";function a(a,b,c){function d(a,b){f.location=b.split("?")[0]}function e(){b.logout(function(){})}var f=this;f.location=void 0,f.logout=e,f.version=c,a.$on("$locationChangeSuccess",d)}angular.module("SetListApp").controller("Index",a),a.$inject=["$scope","UserService","VERSION"]}(),function(){"use strict";function a(a,b,c,d){function e(){f.loading=!0,c.getLoginStatus().then(function(c){"connected"===c.status?a.login(c.authResponse):b.location.href="https://www.facebook.com/dialog/oauth?client_id="+d+"&redirect_uri="+b.location.origin+b.location.pathname},function(a){console.log(a),f.loading=!1})}var f=this;f.loading=!1,f.login=e}angular.module("SetListApp").controller("Login",a),a.$inject=["UserService","$window","$facebook","FB_APPID"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){h.getSetList(d.setListID,l),j.startSetListSynchroniser(),c.$on("$destroy",function(){j.stopSetListSynchroniser()})}function l(a){i.getSongList(a.data.songListID,function(b){function c(b){return b._id===a.data.songs[d]._id}u.songList=b,u.setList={},u.setList.data={},u.setList.data._id=a.data._id,u.setList.data.date=a.data.date,u.setList.data.venue=a.data.venue,u.setList.data.songListID=a.data.songListID,u.setList.data.songs=[];for(var d=0;d<a.data.songs.length;d++){var e=$.grep(u.songList.data.songs,c);u.setList.data.songs.push(e[0])}u.loading=!1})}function m(){var a=e(u.songList.data.songs,u.search)[0];null==a&&(a={_id:f.getObjectId(),name:u.search},u.songList.data.songs.push(a),i.saveSongList(u.songList)),u.setList.data.songs.push(a),u.search=void 0,h.saveSetList(u.setList)}function n(a){u.setList.data.songs.push(u.songList.data.songs[a]),h.saveSetList(u.setList)}function o(){var a={};a.date=u.setList.data.date,a.venue=u.setList.data.venue;var c=b.open({templateUrl:"components/set-list-modal/set-list-modal.html",controller:"SetListModal",controllerAs:"vm",resolve:{setList:function(){return a}}});c.result.then(function(a){u.setList.data.date=a.date,u.setList.data.venue=a.venue,h.saveSetList(u.setList)},function(a){console.log(a)})}function p(a){var b=g(u.songList.data.songs,"name")[a],c=u.songList.data.songs.indexOf(b);u.songList.data.songs[c].edit=!0}function q(a,b){a!==b&&(u.setList.data.songs.splice(b,0,u.setList.data.songs.splice(a,1)[0]),h.saveSetList(u.setList))}function r(a,b){u.moveSong(u.setList.data.songs.indexOf(b),a)}function s(a){u.setList.data.songs.splice(a,1),h.saveSetList(u.setList)}function t(a){var b=g(u.songList.data.songs,"name")[a],c=u.songList.data.songs.indexOf(b);u.songList.data.songs[c].edit=!1,i.saveSongList(u.songList),h.saveSetList(u.setList)}var u=this;u.location=a.absUrl(),u.loading=!0,u.addNewSong=m,u.addSong=n,u.editSetList=o,u.editSong=p,u.moveSong=q,u.onDropComplete=r,u.removeSong=s,u.saveSong=t,k()}angular.module("SetListApp").controller("SetList",a),a.$inject=["$location","$uibModal","$scope","$stateParams","filterFilter","ObjectIdService","orderByFilter","SetListService","SongListService","SynchronisationService"]}(),function(){"use strict";function a(a,b,c){function d(){c.venue=f.venue,c.date=b(f.date).format(),a.close(c)}function e(){a.dismiss()}var f=this;f.venue=c.venue,c.date&&(f.date=b(c.date)._d),f.ok=d,f.cancel=e}angular.module("SetListApp").controller("SetListModal",a),a.$inject=["$uibModalInstance","$moment","setList"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){c.$on("$destroy",function(){i.stopSetListsSynchroniser()}),h.getSetLists(l),i.startSetListsSynchroniser()}function l(a){p.setLists=a,p.loading=!1}function m(){function a(a){}var c=b.open({templateUrl:"components/set-list-modal/set-list-modal.html",controller:"SetListModal as vm",resolve:{setList:function(){return{}}}});c.result.then(o,a)}function n(a){var b=e(g(p.setLists.data,"date"));h.deleteSetList(b[a]._id),p.setLists.data.splice(p.setLists.data.indexOf(b[a]),1)}function o(a){var b={};b.data={},b.data._id=f.getObjectId(),b.data.venue=a.venue,b.data.date=a.date,p.setLists.data.push(b.data),h.saveSetLists(p.setLists),b.data.songListID=j.user().songListID,b.data.songs=[],h.saveSetList(b,!0),d.transitionTo("set-list",{setListID:b.data._id})}var p=this;p.loading=!0,p.setLists={data:[]},p.createSetList=m,p.deleteSetList=n,p.reallyCreateSetList=o,k()}angular.module("SetListApp").controller("SetLists",a),a.$inject=["$log","$uibModal","$scope","$state","futureFilter","ObjectIdService","orderByFilter","SetListService","SynchronisationService","UserService"]}();